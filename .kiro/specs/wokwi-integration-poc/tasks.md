# 实现计划: Wokwi 集成验证概念 (PoC)

## 概述

本实现计划将 Wokwi 仿真器集成验证的设计转换为具体的编码任务。任务按照增量开发的方式组织，每个步骤都建立在前一步的基础上，确保能够及时验证核心功能并发现潜在问题。重点关注 Wokwi 在 Nuxt 4 环境中的集成可行性验证。

### 测试项目配置

为确保测试的一致性，本 PoC 使用以下预定义的测试项目：

- **主要测试项目**: `451385811510693889` (Arduino LED 控制项目)
- **扩展测试项目**: 包括 ESP32、代码注入、自定义芯片等专用测试项目
- **项目来源**: 在 Wokwi 官网创建的专用测试项目，确保稳定性和可访问性

## 任务

- [x] 1. 创建基础项目结构和核心接口
  - 创建 PoC 验证页面的基础结构
  - 定义 TypeScript 接口和类型定义
  - 设置 UnoCSS 赛博朋克主题样式
  - _需求: 1.1, 1.4_

- [ ] 2. 实现 MessageBridge 通信服务
  - [x] 2.1 创建 MessageBridge 类的基础结构
    - 实现消息队列和待发送队列机制
    - 添加消息来源安全验证
    - 实现基础的 postMessage 通信
    - _需求: 3.1, 3.4, 7.1, 7.2_

  - [x] 2.2 编写 MessageBridge 的属性测试
    - **属性 8: 安全通信验证**
    - **验证需求: 7.1, 7.2, 7.3, 7.4**
    - **状态: completed** ✅

  - [x] 2.3 实现 iframe Ready 状态处理机制
    - 添加 Wokwi Ready 信号监听
    - 实现消息队列的自动清空机制
    - 处理竞态条件和超时情况
    - _需求: 1.2, 3.2_

  - [x] 2.4 编写 Ready 状态处理的单元测试
    - 测试消息队列机制
    - 测试超时和错误处理
    - _需求: 1.2, 3.2_

- [ ] 3. 开发 useWokwi Composable
  - [x] 3.1 实现基础的 useWokwi 组合式函数
    - 创建响应式状态管理
    - 实现基础的仿真控制方法
    - 集成 MessageBridge 服务
    - _需求: 2.1, 2.2, 3.1, 3.2_

  - [x] 3.2 编写双向通信的属性测试
    - **属性 2: 双向通信一致性**
    - **验证需求: 2.1, 2.2, 3.1, 3.2, 3.3, 3.4**

  - [x] 3.3 实现代码注入功能
    - 添加 injectCode 方法
    - 实现文件更新消息格式
    - 处理代码注入的确认和错误
    - _需求: 4.6_

  - [x] 3.4 编写代码注入的属性测试
    - **属性 3: 动态代码注入保持功能性**
    - **验证需求: 4.6**

- [ ] 4. 创建 WokwiIntegration 组件
  - [ ] 4.1 实现基础的 Wokwi 嵌入组件
    - 创建 ClientOnly 包装的 iframe 组件
    - 实现基础的加载状态显示
    - 添加错误处理和重试机制
    - _需求: 1.1, 1.4, 1.5_

  - [ ]* 4.2 编写 Wokwi 加载的属性测试
    - **属性 1: Wokwi 仿真器加载和初始化**
    - **验证需求: 1.1, 1.2, 5.1**

  - [ ] 4.3 实现项目动态切换功能
    - 添加项目选择界面
    - 实现项目切换逻辑
    - 确保状态清理和隔离
    - _需求: 4.1, 4.2, 4.3, 4.4_

  - [ ]* 4.4 编写项目切换的属性测试
    - **属性 4: 项目切换状态清理**
    - **验证需求: 4.1, 4.3, 4.4**

- [ ] 5. 检查点 - 基础功能验证
  - 确保所有测试通过，询问用户是否有问题

- [ ] 6. 实现状态监控和显示功能
  - [ ] 6.1 创建实时状态显示组件
    - 显示仿真器运行状态
    - 显示电路状态信息
    - 实现运行时间计时器
    - _需求: 2.3, 2.4_

  - [ ]* 6.2 编写状态同步的属性测试
    - **属性 10: 实时状态同步**
    - **验证需求: 2.3, 2.4**

  - [ ] 6.3 实现性能监控功能
    - 添加内存使用监控
    - 实现消息延迟测量
    - 创建性能指标显示面板
    - _需求: 5.2, 5.3, 5.4_

  - [ ]* 6.4 编写性能稳定性的属性测试
    - **属性 7: 综合性能稳定性**
    - **验证需求: 5.2, 5.3, 5.4**

- [ ] 7. 实现自定义芯片通信验证
  - [ ] 7.1 创建自定义芯片测试项目
    - 准备包含自定义芯片的 Wokwi 项目
    - 实现芯片事件监听器
    - 添加事件显示和日志记录
    - _需求: 3.6_

  - [ ]* 7.2 编写自定义芯片通信的属性测试
    - **属性 5: 自定义芯片事件传递**
    - **验证需求: 3.6**

- [ ] 8. 开发调试和开发者工具
  - [ ] 8.1 创建调试面板组件
    - 实现消息日志显示
    - 添加手动测试触发器
    - 创建状态检查工具
    - _需求: 8.1, 8.2, 8.3_

  - [ ]* 8.2 编写调试工具的单元测试
    - 测试日志记录功能
    - 测试手动触发器
    - _需求: 8.1, 8.2, 8.3_

  - [ ] 8.3 实现错误处理和恢复机制
    - 添加统一的错误处理器
    - 实现自动重试机制
    - 创建错误报告和导出功能
    - _需求: 1.5, 2.5, 3.5, 4.5, 8.4, 8.5_

  - [ ]* 8.4 编写错误处理的属性测试
    - **属性 6: 统一错误处理机制**
    - **验证需求: 1.5, 2.5, 3.5, 4.5**

- [ ] 9. 实现移动端适配和响应式设计
  - [ ] 9.1 添加设备检测和用户引导
    - 实现移动设备检测逻辑
    - 创建优雅的提示界面
    - 添加桌面端引导功能
    - _需求: 6.1, 6.4_

  - [ ]* 9.2 编写移动端适配的属性测试
    - **属性 9: 移动端优雅降级**
    - **验证需求: 6.1, 6.2, 6.3, 6.4**

  - [ ] 9.3 实现响应式布局优化
    - 确保移动端布局完整性
    - 添加只读模式限制
    - 测试不同屏幕尺寸适配
    - _需求: 6.2, 6.3_

- [ ] 10. 检查点 - 功能完整性验证
  - 确保所有测试通过，询问用户是否有问题

- [ ] 11. 创建 PoC 验证页面
  - [ ] 11.1 实现完整的 PoC 验证页面
    - 集成所有开发的组件
    - 创建测试场景选择界面
    - 添加结果展示和导出功能
    - _需求: 所有需求的集成_

  - [ ]* 11.2 编写端到端集成测试
    - 测试完整的用户流程
    - 验证所有功能的协同工作
    - _需求: 所有需求的集成_

- [ ] 12. 生产环境部署验证
  - [ ] 12.1 配置生产环境部署
    - 更新 Nuxt 配置支持 iframe 嵌入
    - 配置 CSP 策略允许 Wokwi 域名
    - 测试 HTTPS 环境下的功能
    - _需求: 1.6_

  - [ ]* 12.2 编写生产环境兼容性测试
    - 测试不同浏览器兼容性
    - 验证 HTTPS 和 CSP 配置
    - _需求: 1.6, 6.5_

- [ ] 13. 最终检查点 - 完整验证报告
  - 生成完整的 PoC 验证报告
  - 总结技术风险和建议
  - 为后续关卡系统开发提供指导

## 注意事项

- 标记为 `*` 的任务是可选的测试任务，可以根据开发进度决定是否实现
- 每个检查点都应该确保前面的功能正常工作后再继续
- 属性测试使用 Vitest + fast-check，每个测试运行 100 次迭代
- 所有组件必须使用 TypeScript 严格模式和 `<script setup>` 语法
- Wokwi 相关组件必须使用 `<ClientOnly>` 包装以确保 SSR 兼容性
- 遵循 KNZN 项目的 UnoCSS 主题变量，禁止硬编码颜色值