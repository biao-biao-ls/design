# 实现计划：项目基础架构搭建

## 概述

将 KNZN 项目基础架构设计转换为可执行的开发任务，采用 Nuxt 4 + PostgreSQL + Docker 容器化部署方案。重点关注环境变量验证、数据库迁移自动化、跨架构兼容性和 GDPR 合规。

## 任务

- [ ] 1. 项目初始化和环境配置
  - [x] 1.1 创建 Nuxt 4 项目结构
    - 初始化 Nuxt 4 项目
    - 配置 TypeScript 和开发工具
    - 设置基础目录结构
    - _需求: 1.1, 1.4, 1.5_

  - [ ] 1.2 配置环境变量类型安全验证
    - 集成 @t3-oss/env-nuxt 进行环境变量验证
    - 创建 env.mjs 配置文件定义所有环境变量
    - 配置启动时环境变量检查
    - 添加开发环境 .env.example 模板
    - _需求: 1.7_

  - [ ]* 1.3 编写环境变量验证属性测试
    - **属性 1: 环境变量验证完整性**
    - **验证需求: 需求 1.7**

- [ ] 2. 数据库系统搭建
  - [ ] 2.1 配置 PostgreSQL 和 Drizzle ORM
    - 设置数据库连接和连接池
    - 创建核心数据表结构
    - 配置数据库迁移系统
    - _需求: 2.1, 2.2_

  - [ ] 2.2 实现生产环境自动迁移
    - 修改 Docker 容器启动脚本（entrypoint.sh 或 CMD）
    - 配置生产环境迁移前备份机制
    - 实现迁移失败自动回滚
    - 添加迁移状态监控和日志记录
    - _需求: 2.2, 2.7_

  - [ ]* 2.3 编写数据库迁移幂等性属性测试
    - **属性 2: 数据库迁移幂等性**
    - **验证需求: 需求 2.2**

  - [ ]* 2.4 编写数据库查询性能属性测试
    - **属性 3: 数据库查询性能保证**
    - **验证需求: 需求 2.3**

  - [ ] 2.5 实现数据库备份系统
    - 创建自动备份脚本
    - 配置加密和云存储上传
    - 实现备份验证机制
    - _需求: 2.5_

  - [ ]* 2.6 编写数据备份完整性属性测试
    - **属性 4: 数据备份完整性**
    - **验证需求: 需求 2.5**

- [ ] 3. 认证系统集成
  - 集成 Better-Auth 认证框架
  - 配置 Google 和 GitHub OAuth
  - 实现 Magic Link 邮件登录
  - 设置会话管理和安全配置
  - _需求: 2.1_

- [ ] 4. 邮件服务配置
  - [ ] 4.1 集成 Resend 邮件服务
    - 配置 Resend API 密钥和发送域名
    - 创建邮件模板系统（欢迎邮件、密码重置等）
    - 实现邮件发送队列和重试机制
    - _需求: 2.1_

  - [ ] 4.2 配置邮件服务 DNS 记录
    - 设置 SPF 记录防止邮件被标记为垃圾邮件
    - 配置 DKIM 签名验证
    - 添加 DMARC 策略
    - 验证邮件送达率
    - _需求: 2.1_

  - [ ] 4.3 实现邮件发送限流和监控
    - 配置发送频率限制
    - 实现邮件发送失败告警
    - 添加邮件送达状态追踪
    - _需求: 6.6, 6.7_

- [ ] 5. 容器化配置
  - [ ] 5.1 创建跨架构 Docker 配置文件
    - 编写 Nuxt 应用 Dockerfile（支持 ARM64 → AMD64）
    - 配置 GitHub Actions docker/setup-buildx-action
    - 处理 sharp 等原生依赖的跨架构兼容性
    - 添加架构检测和验证脚本
    - _需求: 3.1, 3.8, 3.9_

  - [ ] 5.2 创建环境特定的 Docker Compose 文件
    - docker-compose.dev.yml（本地 ARM64，无 platform 限制）
    - docker-compose.prod.yml（生产 AMD64，指定 platform）
    - 配置生产环境日志管理（json-file, max-size: 10m, max-file: 3）
    - 添加日志压缩和标签配置
    - _需求: 3.6, 3.7_

  - [ ]* 5.3 编写容器启动性能属性测试
    - **属性 5: 容器启动性能**
    - **验证需求: 需求 3.2**

  - [ ]* 5.4 编写容器数据持久化属性测试
    - **属性 6: 容器数据持久化**
    - **验证需求: 需求 3.3**

  - [ ] 5.5 配置容器健康检查
    - 实现健康检查端点
    - 配置容器重启策略
    - 设置日志轮转机制
    - _需求: 3.2, 3.5, 3.6, 3.7_

  - [ ]* 5.6 编写日志轮转机制属性测试
    - **属性 7: 日志轮转机制**
    - **验证需求: 需求 3.6**

- [ ] 6. 开发环境配置
  - 创建开发环境 Docker Compose
  - 编写一键启动脚本
  - 配置 PgAdmin 数据库管理
  - 设置开发环境迁移脚本
  - _需求: 1.6_

- [ ] 7. HTTPS 和 SSL 配置
  - [ ] 7.1 配置 Nginx 反向代理和 SSL
    - 创建 Nginx 配置文件
    - 配置 Cloudflare SSL 证书路径 (ssl/cf_cert.pem, ssl/cf_key.pem)
    - 设置 HTTPS 重定向和安全配置
    - _需求: 5.1, 5.2_

  - [ ]* 7.2 编写 HTTPS 重定向属性测试
    - **属性 8: HTTPS 重定向一致性**
    - **验证需求: 需求 5.1**

  - [ ]* 7.3 编写 SSL 证书有效性属性测试
    - **属性 9: SSL 证书有效性**
    - **验证需求: 需求 5.2**

  - [ ] 7.4 实现安全头配置
    - 配置 CSP、HSTS 等安全头
    - 设置 CORS 策略
    - 实现安全威胁防护
    - _需求: 5.5_

- [ ] 8. 监控和错误处理系统
  - [ ] 8.1 实现错误监控系统
    - 创建错误日志记录
    - 集成第三方错误追踪（Sentry 或 GlitchTip）
    - 实现邮件告警机制
    - _需求: 6.1, 6.2, 6.3, 6.6, 6.7_

  - [ ] 8.2 配置生产环境日志管理
    - 设置 Docker 日志轮转（10MB max, 3 files）
    - 配置日志压缩和清理策略
    - 实现日志聚合和搜索
    - 添加日志监控告警
    - _需求: 3.6, 6.1_

  - [ ]* 8.3 编写监控数据连续性属性测试
    - **属性 10: 监控数据连续性**
    - **验证需求: 需求 6.1**

  - [ ] 8.4 创建系统监控脚本
    - 实现容器状态检查
    - 监控磁盘和内存使用
    - 配置应用健康检查
    - _需求: 6.4_

- [ ] 9. GDPR 合规功能
  - [ ] 9.1 实现 Cookie 同意管理
    - 创建 Cookie 同意横幅
    - 实现用户选择记录
    - 配置隐私政策集成
    - _需求: 7.1_

  - [ ] 9.2 实现数据导出功能
    - 创建用户数据导出 API
    - 实现数据格式化和打包
    - 配置导出文件生成
    - _需求: 7.2_

  - [ ]* 9.3 编写 GDPR 数据导出属性测试
    - **属性 11: GDPR 数据导出完整性**
    - **验证需求: 需求 7.2**

  - [ ] 9.4 实现账户删除功能
    - 创建账户删除 API
    - 实现数据清理机制
    - 配置宽限期管理
    - _需求: 7.3_

  - [ ]* 9.5 编写 GDPR 数据删除属性测试
    - **属性 12: GDPR 数据删除彻底性**
    - **验证需求: 需求 7.3**

- [ ] 10. CI/CD 流程配置
  - [ ] 10.1 创建 GitHub Actions 工作流
    - 配置自动化测试流程
    - 使用 docker/setup-buildx-action 进行跨平台构建
    - 设置环境变量验证步骤
    - _需求: 4.1, 4.2_

  - [ ] 10.2 配置自动部署到 VPS
    - 实现 SSH 部署脚本
    - 添加部署前数据库迁移
    - 配置部署后健康检查验证
    - 实现部署失败自动回滚
    - _需求: 4.3, 4.4, 4.5_

  - [ ] 10.3 添加部署监控和通知
    - 配置部署成功/失败邮件通知
    - 实现部署状态 Webhook
    - 添加部署性能监控
    - _需求: 4.4_

- [ ] 11. 检查点 - 基础架构验证
  - 确保所有测试通过，询问用户是否有问题

- [ ] 12. 生产环境部署
  - [ ] 12.1 VPS 环境准备
    - 配置 Contabo VPS 服务器
    - 安装 Docker 和 Docker Compose
    - 设置防火墙和安全配置
    - _需求: 3.1, 5.1_

  - [ ] 12.2 生产环境配置
    - 配置生产环境变量
    - 验证 Cloudflare SSL 证书配置
    - 配置定时任务（备份、监控）
    - _需求: 5.3_

  - [ ] 12.3 部署验证和测试
    - 执行完整部署流程
    - 验证所有服务正常运行
    - 测试健康检查端点
    - _需求: 3.2, 6.4_

- [ ] 13. 最终检查点 - 完整系统验证
  - 确保所有测试通过，询问用户是否有问题

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求，确保可追溯性
- 检查点任务确保增量验证和用户反馈
- 属性测试验证通用正确性属性
- 单元测试验证具体示例和边界情况