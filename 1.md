vps 服务器我使用的是 contabo 不是 Vercel

既然使用 **Contabo VPS** 全私有化部署，那么 **Vercel 被移除**，架构模式从“Serverless + VPS”变为完全的 **“单机容器化集群”**。

这意味着我们需要**大幅保留并升级**旧文档中的 Docker 和 Nginx 部分，但要把核心应用从 NestJS 替换为 Nuxt 4 (Nitro Server)。

这是针对 **Contabo VPS 架构** 的调整方案，请确认是否符合你的预期：

---

### 🏛️ 修正后的架构：KNZN Contabo 单机集群版

我们将在你的 Contabo VPS 上运行一个完整的 `docker-compose` 编排，包含以下服务：

1. **Ingress (入口)**: **Nginx** (处理 SSL、反向代理、静态资源缓存、Gzip)。
2. **App Service**: **Nuxt 4 Container** (Nitro Node Server，承担前后端所有逻辑)。
3. **Database**: **PostgreSQL** (自托管，挂载 VPS 数据盘)。
4. **Cache**: **Redis** (用于 Nitro 缓存、限流)。
5. **Ops**: **Watchtower** (可选，用于自动更新镜像) 或简单的 CI/CD 脚本。

---

### 📝 修正后的文档规划 (针对 Contabo)

我将调整之前的建议，特别是 **文档 3 (运维)** 将重新变回重头戏。

#### 📘 文档 1: KNZN 全栈开发手册 (The Bible)

* **核心调整**：
* **Nuxt 配置**：`nitro.preset` 设置为 `node-server` 或 `docker`，而非 vercel。
* **鉴权 (Better-Auth)**：在 Nginx 反代环境下，需要配置 `TRUST_PROXY` 和 Cookie 的 `Secure` 属性，确保鉴权在 HTTPS 下正常工作。
* **文件上传**：依然坚持 **前端直传 R2**。**千万不要**让文件流经过 Contabo 的 Nginx 和 Nuxt 容器，这会瞬间吃光你的 VPS 带宽和内存。



#### 📗 文档 2: 核心交互与仿真开发指南

* （保持不变，这部分与部署环境解耦）

#### 📕 文档 3: Docker 全栈部署与运维指南 (Ops) - **重写重点**

这份文档将基于旧的 `03-docker-deployment-guide.md` 进行现代化改造：

* **Docker Compose 编排**：
* 编写一个整合了 `nuxt-app` + `postgres` + `redis` + `nginx` 的 `docker-compose.yml`。
* 不再需要 `backend` 和 `web` 两个服务，合并为一个 `knzn-app` 服务。


* **Dockerfile 优化**：
* 编写 Nuxt 4 的多阶段构建 Dockerfile（Build Stage -> Run Stage），产出极小的 Alpine 镜像。


* **Nginx 配置 (关键)**：
* 配置 HTTP/2。
* 配置 SSL 证书自动续签 (使用 Certbot 或 acme.sh)。
* **重要**：配置 Nginx 缓存策略，替 Nitro 分担静态资源压力（因为没有 Vercel Edge 了）。


* **CI/CD (GitHub Actions)**：
* 实现：本地 Push -> GitHub Actions 构建 Docker 镜像 -> 推送 GHCR -> SSH 连入 Contabo -> 拉取新镜像 -> 重启容器。


* **系统安全 (VPS Hardening)**：
* 配置 UFW 防火墙（只开放 80, 443, 22）。
* 配置 Fail2Ban 防止 SSH 爆破。



#### 📙 文档 4: 商业化与合规指南

* （保持不变，Webhook 回调地址改为你的域名）

---

### 💡 针对 Contabo 的特别建议

1. **内存限制**：Contabo 的 CPU 虽然是多核但通常是共享性能，Node.js (Nuxt Server) 比较吃内存。
* *建议*：在 `docker-compose` 中限制 Postgres 的共享内存，给 Nuxt 留足空间。


2. **构建策略**：**不要在 Contabo 上运行 `npm run build**`。
* *原因*：构建过程极其消耗 CPU/内存，容易把 VPS 卡死。
* *建议*：利用 **GitHub Actions** 进行构建打包成 Docker 镜像，VPS 只负责 `docker pull` 和运行。
